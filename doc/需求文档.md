# 基金折溢价数据爬取与服务需求文档

## 1. 项目概述

**项目名称**：基金折溢价爬取与提醒服务（Node.js + MySQL 版）  

**项目目标**：  
- 定期抓取基金折价/溢价数据，存储到数据库  
- 支持按阈值触发提醒（邮件、Telegram等）  
- 提供 RESTful API 查询最新基金数据  
- 构建可扩展、稳定的服务化系统，支持定时抓取和增量更新  

**目标用户**：投资者、基金分析师、量化交易/套利研究人员  

---

## 2. 数据源

**目标页面**：[http://www.xiaoyudecqg.cn/mphtl/#/Arbitrage/remind](http://www.xiaoyudecqg.cn/mphtl/#/Arbitrage/remind)  

**数据接口**：  
- GET http://xiaoyudecqg.cn/htl/mp/api/arbitrage/list?type=0  
- 请求需携带 token 和必要的 HTTP headers（Referer、Origin、User-Agent等）  
- 接口返回 JSON 数据，包含字段示例：  

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| fundCode | string | 基金代码 |
| fundName | string | 基金名称 |
| type | int | 基金类型（ETF、LOF等） |
| openRemind | boolean | 是否开启提醒 |
| value | decimal | 当前估值 |
| discount | decimal | 折溢价率 |
| estimateLimit | decimal | 估值上下限 |
| currentPrice | decimal | 当前价格 |
| increaseRt | decimal | 涨跌幅 |
| updateTime | datetime | 数据更新时间 |

---

## 3. 功能需求

### 3.1 数据爬取模块
- 调用 API 获取最新基金折溢价数据  
- 支持 token 配置和 HTTP header 配置  
- 捕获异常并记录日志  
- 支持增量更新（同一基金同一时间只存一次）  

### 3.2 数据存储模块
- 使用 MySQL 数据库  
- 表设计示例：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int, 主键, 自增 | 唯一ID |
| fund_code | varchar(20) | 基金代码 |
| fund_name | varchar(100) | 基金名称 |
| type | int | 基金类型 |
| value | decimal(10,4) | 当前估值 |
| discount | decimal(5,2) | 折溢价率 |
| estimate_limit | decimal(5,2) | 估值上下限 |
| current_price | decimal(10,3) | 当前价格 |
| increase_rt | decimal(5,2) | 涨跌幅 |
| update_time | datetime | 数据更新时间 |
| open_remind | boolean | 是否开启提醒 |
| created_at | datetime | 数据入库时间 |
| unique_fund_update | unique(fund_code, update_time) | 保证同一基金同一时间只存一次 |

### 3.3 定时任务模块
- 使用定时调度执行数据抓取（每天两次：10:00、15:00）  
- 执行流程：抓取 → 数据入库 → 阈值检查 → 触发提醒（可选）  

### 3.4 提醒模块（可选）
- 阈值触发提醒（如折溢价>3%或<-3%）  
- 支持提醒方式：  
  - 控制台输出  
  - 邮件（SMTP）  
  - Telegram Bot  
  - Webhook调用  
- 提醒参数可通过配置文件或环境变量设置  

### 3.5 API服务模块
- 提供 RESTful 接口查询数据  
- 接口示例：
  - GET /api/funds → 返回最新数据列表  
  - GET /api/funds/:code → 查询指定基金  
  - GET /api/funds?discount_lt=-3&discount_gt=3 → 按折溢价区间筛选  
- 返回格式为 JSON，支持跨域  

---
## 4. 技术需求
- 语言：Node.js >=18  
- 数据库：MySQL  
- HTTP客户端：axios  
- 定时任务：node-cron  
- REST API：Express  
- 日志管理：winston  
- 配置管理：dotenv  

**可扩展**：未来可增加前端展示、统计分析、更多基金类型  

---

## 5. 非功能需求
- 稳定性：抓取异常不影响整个系统运行  
- 可扩展性：易于增加新基金类型、提醒渠道  
- 安全性：token敏感信息通过 .env 文件管理，不硬编码  
- 可维护性：模块化设计（crawler/db/scheduler/notifier/server/utils）  
- 性能：直接调用 API，无需页面渲染，抓取效率高  

---

## 6. 运行与部署要求
- 环境：Node.js + MySQL  
- 部署方式：可本地运行或部署到云服务器  
- 依赖管理：npm / package.json  
- 启动流程：
  1. 配置 `.env`  
  2. 创建 MySQL 数据库与表  
  3. 安装依赖 `npm install`  
  4. 启动程序 `npm start`  
- 日志：按日期生成日志文件，记录抓取和异常信息  

---

## 7. 未来扩展方向
- 支持更多基金类型（封闭式基金、ETF、LOF等）  
- 增加前端可视化界面（折溢价趋势图、基金列表）  
- 增加历史数据分析与统计报表  
- 支持多用户配置提醒阈值
